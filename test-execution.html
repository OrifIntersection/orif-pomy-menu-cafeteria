<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Test d'ExÃ©cution - ORIF</title>
  <link rel="stylesheet" href="./style.css">
  <style>
    .test-container {
      max-width: 1200px;
      margin: 2rem auto;
      padding: 2rem;
      background: #424549;
      color: white;
      border-radius: 8px;
    }
    
    .test-section {
      background: #36393f;
      padding: 1.5rem;
      margin: 1rem 0;
      border-radius: 8px;
      border-left: 4px solid #7289da;
    }
    
    .test-logs {
      background: #2f3136;
      color: #00ff00;
      padding: 1rem;
      border-radius: 4px;
      font-family: 'Courier New', monospace;
      font-size: 0.85rem;
      max-height: 400px;
      overflow-y: auto;
      white-space: pre-wrap;
      margin: 1rem 0;
    }
    
    .test-status {
      display: inline-block;
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
      font-size: 0.8rem;
      font-weight: bold;
      margin: 0.25rem 0;
    }
    
    .status-success { background: #3ba55c; color: white; }
    .status-error { background: #ed4245; color: white; }
    .status-warning { background: #faa61a; color: white; }
    .status-running { background: #5865f2; color: white; }
    
    .btn {
      background: #5865f2;
      color: white;
      border: none;
      padding: 0.8rem 1.5rem;
      border-radius: 4px;
      cursor: pointer;
      margin: 0.5rem 0.5rem 0.5rem 0;
      font-size: 0.9rem;
    }
    
    .btn:hover { background: #4752c4; }
    .btn.danger { background: #ed4245; }
    .btn.danger:hover { background: #c73741; }
    
    .execution-result {
      margin: 1rem 0;
      padding: 1rem;
      border-radius: 4px;
      border-left: 4px solid #7289da;
    }
    
    .result-success { border-color: #3ba55c; background: rgba(59, 165, 92, 0.1); }
    .result-error { border-color: #ed4245; background: rgba(237, 66, 69, 0.1); }
    .result-warning { border-color: #faa61a; background: rgba(250, 166, 26, 0.1); }
  </style>
</head>
<body>
  <div class="test-container">
    <h1>ğŸ§ª Test d'ExÃ©cution en Temps RÃ©el</h1>
    <p>Teste vraiment l'exÃ©cution des fonctions et vÃ©rifie les rÃ©sultats avant/pendant/aprÃ¨s.</p>
    
    <div class="test-section">
      <h3>Tests Automatiques</h3>
      <button class="btn" onclick="testPopupExecution()">ğŸ”¥ Tester Popup "Donner mon avis"</button>
      <button class="btn" onclick="testButtonClick()">ğŸ¯ Tester Clic Bouton</button>
      <button class="btn" onclick="testAllFunctions()">âš¡ Tester Toutes Fonctions</button>
      <button class="btn" onclick="testAuthFlow()">ğŸ” Tester Authentification</button>
      <button class="btn danger" onclick="clearLogs()">ğŸ—‘ï¸ Effacer</button>
    </div>
    
    <div class="test-section">
      <h3>ğŸ“Š RÃ©sultats des Tests</h3>
      <div id="test-status">
        <div>Ã‰tat Popup: <span id="popup-state" class="test-status status-running">Test en attente</span></div>
        <div>Fonctions JS: <span id="functions-state" class="test-status status-running">Test en attente</span></div>
        <div>Ã‰vÃ©nements: <span id="events-state" class="test-status status-running">Test en attente</span></div>
      </div>
    </div>
    
    <div class="test-section">
      <h3>ğŸ“‹ Logs d'ExÃ©cution DÃ©taillÃ©s</h3>
      <div id="execution-logs" class="test-logs">
PrÃªt Ã  tester. Cliquez sur un bouton pour commencer les tests d'exÃ©cution...
      </div>
    </div>
    
    <div class="test-section">
      <h3>ğŸ” RÃ©sultats d'Analyse</h3>
      <div id="analysis-results"></div>
    </div>
    
    <div style="margin-top: 2rem; text-align: center;">
      <a href="./index.html" class="btn">ğŸ  Retour Ã  l'accueil</a>
      <a href="./diagnostic-advanced.html" class="btn">ğŸ”§ Diagnostic AvancÃ©</a>
    </div>
  </div>

  <!-- Scripts nÃ©cessaires -->
  <script src="./app.js"></script>
  <script src="./member.js"></script>
  <script src="./avis-system.js"></script>
  <script src="./error-tracker.js"></script>
  
  <script>
    // SYSTÃˆME DE TEST D'EXÃ‰CUTION RÃ‰EL
    
    let logs = [];
    const logsArea = document.getElementById('execution-logs');
    const analysisArea = document.getElementById('analysis-results');
    
    function log(message, type = 'info') {
      const timestamp = new Date().toLocaleTimeString();
      const colors = {
        info: '#00ff00',
        error: '#ff6666',
        warning: '#ffaa00',
        success: '#66ff66',
        debug: '#66aaff'
      };
      
      const logEntry = `[${timestamp}] ${message}`;
      logs.push({ message: logEntry, type });
      
      if (logsArea) {
        logsArea.textContent += logEntry + '\n';
        logsArea.scrollTop = logsArea.scrollHeight;
      }
      
      console.log(logEntry);
      return logEntry;
    }
    
    function updateStatus(elementId, text, type) {
      const el = document.getElementById(elementId);
      if (el) {
        el.textContent = text;
        el.className = `test-status status-${type}`;
      }
    }
    
    function addAnalysisResult(title, content, type = 'info') {
      const resultDiv = document.createElement('div');
      resultDiv.className = `execution-result result-${type}`;
      resultDiv.innerHTML = `<h4>${title}</h4><p>${content}</p>`;
      analysisArea.appendChild(resultDiv);
    }
    
    function clearLogs() {
      logs = [];
      if (logsArea) logsArea.textContent = 'Logs effacÃ©s. PrÃªt pour de nouveaux tests...\n';
      if (analysisArea) analysisArea.innerHTML = '';
      updateStatus('popup-state', 'Test en attente', 'running');
      updateStatus('functions-state', 'Test en attente', 'running');
      updateStatus('events-state', 'Test en attente', 'running');
    }
    
    async function testPopupExecution() {
      log('ğŸ”¥ DÃ‰BUT TEST EXÃ‰CUTION POPUP', 'info');
      log('=================================', 'info');
      
      updateStatus('popup-state', 'Test en cours...', 'running');
      
      // Ã‰TAPE 1: VÃ©rification des Ã©lÃ©ments
      log('\nğŸ“‹ Ã‰TAPE 1: VÃ©rification des Ã©lÃ©ments DOM', 'info');
      
      const button = document.getElementById('open-rating-popup');
      const popup = document.getElementById('rating-popup');
      
      if (!button) {
        log('âŒ ERREUR: Bouton "open-rating-popup" introuvable', 'error');
        updateStatus('popup-state', 'Bouton manquant', 'error');
        addAnalysisResult('Test Popup', 'Le bouton "Donner mon avis" est introuvable dans le DOM', 'error');
        return;
      }
      
      if (!popup) {
        log('âŒ ERREUR: Popup "rating-popup" introuvable', 'error');
        updateStatus('popup-state', 'Popup manquant', 'error');
        addAnalysisResult('Test Popup', 'L\'Ã©lÃ©ment popup est introuvable dans le DOM', 'error');
        return;
      }
      
      log('âœ… Bouton trouvÃ©: ' + button.tagName, 'success');
      log('âœ… Popup trouvÃ©: ' + popup.tagName, 'success');
      
      // Ã‰TAPE 2: Ã‰tat initial
      log('\nğŸ“Š Ã‰TAPE 2: Analyse de l\'Ã©tat initial', 'info');
      
      const initialDisplay = popup.style.display;
      const initialVisibility = popup.style.visibility;
      const computedStyle = window.getComputedStyle(popup);
      
      log(`ğŸ” Display initial: "${initialDisplay || 'non dÃ©fini'}"`, 'debug');
      log(`ğŸ” Visibility initial: "${initialVisibility || 'non dÃ©fini'}"`, 'debug');
      log(`ğŸ” Display calculÃ©: "${computedStyle.display}"`, 'debug');
      
      const isInitiallyHidden = (initialDisplay === 'none') || 
                                (computedStyle.display === 'none') ||
                                (initialDisplay === '');
      
      if (isInitiallyHidden) {
        log('âœ… Ã‰tat initial correct: popup cachÃ©', 'success');
      } else {
        log('âš ï¸ Ã‰tat initial: popup visible (peut Ãªtre normal)', 'warning');
      }
      
      // Ã‰TAPE 3: Test des Ã©vÃ©nements attachÃ©s
      log('\nğŸ¯ Ã‰TAPE 3: VÃ©rification des Ã©vÃ©nements', 'info');
      
      const hasOnClick = button.onclick !== null;
      const onClickAttr = button.getAttribute('onclick');
      
      log(`ğŸ“‹ onclick property: ${hasOnClick ? 'OUI' : 'NON'}`, hasOnClick ? 'success' : 'warning');
      log(`ğŸ“‹ onclick attribute: ${onClickAttr ? 'OUI' : 'NON'}`, onClickAttr ? 'success' : 'warning');
      
      if (!hasOnClick && !onClickAttr) {
        log('âŒ ERREUR: Aucun Ã©vÃ©nement onclick dÃ©tectÃ©', 'error');
        updateStatus('events-state', 'Ã‰vÃ©nements manquants', 'error');
        addAnalysisResult('Ã‰vÃ©nements', 'Le bouton n\'a pas d\'Ã©vÃ©nement onclick attachÃ©', 'error');
        return;
      }
      
      updateStatus('events-state', 'Ã‰vÃ©nements OK', 'success');
      
      // Ã‰TAPE 4: Test des fonctions disponibles
      log('\nğŸ”§ Ã‰TAPE 4: VÃ©rification des fonctions', 'info');
      
      if (!window.avisSys) {
        log('âŒ ERREUR: window.avisSys non disponible', 'error');
        updateStatus('functions-state', 'AvisSys manquant', 'error');
        addAnalysisResult('Fonctions', 'Le systÃ¨me d\'avis (avisSys) n\'est pas initialisÃ©', 'error');
        return;
      }
      
      if (typeof window.avisSys.openPopup !== 'function') {
        log('âŒ ERREUR: avisSys.openPopup n\'est pas une fonction', 'error');
        updateStatus('functions-state', 'openPopup manquant', 'error');
        addAnalysisResult('Fonctions', 'La fonction openPopup n\'est pas disponible', 'error');
        return;
      }
      
      log('âœ… avisSys disponible', 'success');
      log('âœ… openPopup disponible', 'success');
      updateStatus('functions-state', 'Fonctions OK', 'success');
      
      // Ã‰TAPE 5: EXÃ‰CUTION RÃ‰ELLE
      log('\nğŸš€ Ã‰TAPE 5: EXÃ‰CUTION DU TEST', 'info');
      log('ğŸ”¥ Tentative d\'ouverture du popup...', 'warning');
      
      try {
        // Observer les changements
        const observer = new MutationObserver((mutations) => {
          mutations.forEach((mutation) => {
            if (mutation.type === 'attributes' && mutation.attributeName === 'style') {
              const newDisplay = popup.style.display;
              log(`ğŸ”„ Changement dÃ©tectÃ©: display = "${newDisplay}"`, 'debug');
            }
          });
        });
        
        observer.observe(popup, { attributes: true, attributeFilter: ['style'] });
        
        // ExÃ©cuter la fonction
        window.avisSys.openPopup();
        log('âœ… Fonction openPopup() exÃ©cutÃ©e sans erreur', 'success');
        
        // VÃ©rification immÃ©diate
        const immediateDisplay = popup.style.display;
        log(`ğŸ“Š Display immÃ©diatement aprÃ¨s: "${immediateDisplay}"`, 'debug');
        
        // VÃ©rification aprÃ¨s dÃ©lai
        setTimeout(() => {
          const delayedDisplay = popup.style.display;
          const isNowVisible = (delayedDisplay === 'flex') || 
                               (delayedDisplay === 'block') ||
                               (window.getComputedStyle(popup).display !== 'none');
          
          log(`ğŸ“Š Display aprÃ¨s 500ms: "${delayedDisplay}"`, 'debug');
          log(`ğŸ“Š Popup visible: ${isNowVisible ? 'OUI' : 'NON'}`, isNowVisible ? 'success' : 'error');
          
          if (isNowVisible) {
            log('ğŸ‰ SUCCÃˆS TOTAL: Le popup s\'ouvre correctement!', 'success');
            updateStatus('popup-state', 'Fonctionne parfaitement', 'success');
            addAnalysisResult('Test Popup', 'Le popup s\'ouvre correctement quand on clique sur "Donner mon avis"', 'success');
            
            // Test de fermeture
            if (window.avisSys.closePopup) {
              setTimeout(() => {
                log('\nğŸ”’ Test de fermeture automatique...', 'info');
                window.avisSys.closePopup();
                
                setTimeout(() => {
                  const closedDisplay = popup.style.display;
                  const isNowHidden = (closedDisplay === 'none') || 
                                     (window.getComputedStyle(popup).display === 'none');
                  
                  log(`ğŸ“Š Display aprÃ¨s fermeture: "${closedDisplay}"`, 'debug');
                  
                  if (isNowHidden) {
                    log('âœ… Fermeture fonctionne aussi!', 'success');
                    addAnalysisResult('Fermeture Popup', 'La fermeture du popup fonctionne correctement', 'success');
                  } else {
                    log('âš ï¸ Fermeture partielle ou diffÃ©rÃ©e', 'warning');
                    addAnalysisResult('Fermeture Popup', 'La fermeture du popup ne fonctionne pas immÃ©diatement', 'warning');
                  }
                }, 300);
              }, 2000);
            }
            
          } else {
            log('âŒ Ã‰CHEC: Le popup ne s\'ouvre PAS', 'error');
            log('ğŸ” La fonction s\'exÃ©cute mais ne change pas l\'affichage', 'error');
            updateStatus('popup-state', 'Ne s\'ouvre pas', 'error');
            addAnalysisResult('Test Popup', 'La fonction openPopup() s\'exÃ©cute sans erreur mais le popup ne devient pas visible. ProblÃ¨me probable dans le code de la fonction.', 'error');
          }
          
          observer.disconnect();
        }, 500);
        
      } catch (error) {
        log(`âŒ ERREUR d'exÃ©cution: ${error.message}`, 'error');
        log(`ğŸ” Stack trace: ${error.stack}`, 'error');
        updateStatus('popup-state', 'Erreur d\'exÃ©cution', 'error');
        addAnalysisResult('Erreur ExÃ©cution', `Erreur lors de l'exÃ©cution de openPopup(): ${error.message}`, 'error');
      }
      
      log('\n=================================', 'info');
      log('ğŸ FIN DU TEST POPUP', 'info');
    }
    
    async function testButtonClick() {
      log('\nğŸ¯ TEST SIMULATION CLIC BOUTON', 'info');
      log('==============================', 'info');
      
      const button = document.getElementById('open-rating-popup');
      if (!button) {
        log('âŒ Bouton introuvable', 'error');
        return;
      }
      
      log('ğŸ”¥ Simulation du clic utilisateur...', 'warning');
      
      try {
        // Simuler un clic rÃ©el
        const clickEvent = new MouseEvent('click', {
          bubbles: true,
          cancelable: true,
          view: window
        });
        
        button.dispatchEvent(clickEvent);
        log('âœ… Ã‰vÃ©nement click dispatchÃ©', 'success');
        
        // VÃ©rifier le rÃ©sultat
        setTimeout(() => {
          const popup = document.getElementById('rating-popup');
          if (popup) {
            const isVisible = popup.style.display === 'flex' || popup.style.display === 'block';
            log(`ğŸ“Š Popup visible aprÃ¨s clic simulÃ©: ${isVisible ? 'OUI' : 'NON'}`, isVisible ? 'success' : 'error');
            
            if (isVisible) {
              addAnalysisResult('Simulation Clic', 'Le clic simulÃ© ouvre correctement le popup', 'success');
            } else {
              addAnalysisResult('Simulation Clic', 'Le clic simulÃ© ne parvient pas Ã  ouvrir le popup', 'error');
            }
          }
        }, 500);
        
      } catch (error) {
        log(`âŒ Erreur simulation clic: ${error.message}`, 'error');
        addAnalysisResult('Simulation Clic', `Erreur lors de la simulation: ${error.message}`, 'error');
      }
    }
    
    async function testAllFunctions() {
      log('\nâš¡ TEST DE TOUTES LES FONCTIONS', 'info');
      log('===============================', 'info');
      
      const functions = [
        { name: 'window.currentUser', test: () => typeof window.currentUser === 'function' },
        { name: 'window.avisSys.openPopup', test: () => window.avisSys && typeof window.avisSys.openPopup === 'function' },
        { name: 'window.avisSys.closePopup', test: () => window.avisSys && typeof window.avisSys.closePopup === 'function' },
        { name: 'window.avisSys.ajouterAvis', test: () => window.avisSys && typeof window.avisSys.ajouterAvis === 'function' },
        { name: 'window.chargerMenuDuJour', test: () => typeof window.chargerMenuDuJour === 'function' },
        { name: 'window.renderAccountArea', test: () => typeof window.renderAccountArea === 'function' }
      ];
      
      let successCount = 0;
      
      for (const func of functions) {
        try {
          const result = func.test();
          if (result) {
            log(`âœ… ${func.name} - Disponible`, 'success');
            successCount++;
          } else {
            log(`âŒ ${func.name} - Manquante`, 'error');
          }
        } catch (error) {
          log(`âŒ ${func.name} - Erreur: ${error.message}`, 'error');
        }
      }
      
      const percentage = Math.round((successCount / functions.length) * 100);
      log(`ğŸ“Š Score: ${successCount}/${functions.length} (${percentage}%)`, percentage > 80 ? 'success' : 'warning');
      
      updateStatus('functions-state', `${successCount}/${functions.length} OK`, percentage > 80 ? 'success' : 'warning');
      addAnalysisResult('Test Fonctions', `${successCount} fonctions sur ${functions.length} sont disponibles (${percentage}%)`, percentage > 80 ? 'success' : 'warning');
    }
    
    async function testAuthFlow() {
      log('\nğŸ” TEST FLUX AUTHENTIFICATION', 'info');
      log('============================', 'info');
      
      try {
        if (typeof window.currentUser === 'function') {
          const user = window.currentUser();
          
          if (user) {
            log(`âœ… Utilisateur connectÃ©: ${user.name || 'Sans nom'}`, 'success');
            log(`ğŸ“§ Email: ${user.email || 'Non dÃ©fini'}`, 'info');
            log(`ğŸ‘¤ RÃ´le: ${user.role || 'Non dÃ©fini'}`, 'info');
            addAnalysisResult('Authentification', `Utilisateur connectÃ©: ${user.name} (${user.role})`, 'success');
          } else {
            log('â„¹ï¸ Aucun utilisateur connectÃ©', 'info');
            addAnalysisResult('Authentification', 'Aucun utilisateur actuellement connectÃ©', 'warning');
          }
        } else {
          log('âŒ Fonction currentUser non disponible', 'error');
          addAnalysisResult('Authentification', 'SystÃ¨me d\'authentification non initialisÃ©', 'error');
        }
      } catch (error) {
        log(`âŒ Erreur test auth: ${error.message}`, 'error');
        addAnalysisResult('Authentification', `Erreur: ${error.message}`, 'error');
      }
    }
    
    // Initialisation
    document.addEventListener('DOMContentLoaded', () => {
      log('ğŸ”§ SystÃ¨me de test d\'exÃ©cution initialisÃ©');
      log('PrÃªt Ã  tester les fonctions en temps rÃ©el...\n');
    });
  </script>
</body>
</html>