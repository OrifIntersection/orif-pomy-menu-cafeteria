<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Menu ORIF - Menu du jour</title>
  <link rel="stylesheet" href="./style.css"/>
  <link rel="stylesheet" href="./responsive.css"/>
</head>
<body>
  <header>
    <div class="logo-container">
      <img src="./logo-orif.png" alt="Logo ORIF" class="logo-orif" />
      <div>
        <h1>Menu du jour ‚Äì ORIF-POMY</h1>
        <p class="date" id="date-actuelle">Mercredi 14 ao√ªt 2025</p>
      </div>
    </div>

    <div class="user-options">
      <div id="account-area">
        <a class="btn" href="./login.html">Se connecter</a>
      </div>
      <select name="langue" id="langue">
        <option value="fr">FR</option>
        <option value="en">EN</option>
        <option value="de">DE</option>
      </select>
    </div>
  </header>

  <nav class="header-nav">
    <div class="nav-container">
      <a href="#plat" class="nav-item active">Plat du jour</a>
      <span class="nav-divider">|</span>
      <a href="#dessert" class="nav-item">Dessert</a>
      <span class="nav-divider">|</span>
      <a href="#self" class="nav-item">Self-service</a>
      <span class="nav-divider">|</span>
      <a href="#salades" class="nav-item">Salades</a>
      <span class="nav-divider">|</span>
      <a href="#vegetarien" class="nav-item">Plat v√©g√©tarien</a>
    </div>
  </nav>

  <div class="main-layout">
    <!-- Contenu principal large -->
    <main class="content">

      <!-- PLAT DU JOUR -->
      <section id="plat" class="section-card" data-menu-today="true">
        <h2>Plat du jour</h2>
        <div class="badges" id="plat-badges"></div>
        <img id="plat-img" src="./plat_jour.jpg" alt="Plat du jour"/>
        <p><strong>Nom :</strong> <span id="plat-nom">Poulet au curry</span></p>
        <div id="menu-today" style="display: none;">Menu du jour charg√©</div>
        <p><strong>Description :</strong> <span id="plat-desc">Riz basmati, l√©gumes vapeur</span></p>
        
        <!-- Section avis attach√©e au menu du jour -->
        <div id="avis-section">
          <div class="avis-header-section">
            <h3>Avis sur le menu d'aujourd'hui</h3>
            <button id="open-rating-popup" onclick="openSimplePopup()" class="btn btn-rating">Donner mon avis</button>
          </div>
          <div id="moyenne-avis" class="moyenne-avis">Moyenne : <span id="moyenne-note">0</span>/5</div>
          <ul id="avis-list">
            <li class="aucun-avis">Aucun avis pour aujourd'hui</li>
          </ul>
        </div>
      </section>

      <!-- DESSERT -->
      <section id="dessert" class="section-card">
        <h2>Dessert du jour</h2>
        <div class="badges" id="dessert-badges"></div>
        <p id="dessert-content">Cr√®me br√ªl√©e maison avec √©clats de caramel</p>
      </section>

      <!-- SELF -->
      <section id="self" class="section-card">
        <h2>Self-service du jour</h2>
        <ul id="self-list">
          <li>P√¢tes bolognaises</li>
          <li>Pizza 4 fromages</li>
          <li>Gratin de l√©gumes</li>
        </ul>
      </section>

      <!-- SALADES -->
      <section id="salades" class="section-card">
        <h2>Bar √† salades</h2>
        <p>Composez votre salade avec :</p>
        <ul id="salades-list">
          <li>Laitue, roquette, carottes r√¢p√©es</li>
          <li>≈íufs, thon, ma√Øs, tomates cerises</li>
          <li>Vinaigrette maison, sauce yogourt</li>
        </ul>
      </section>

      <!-- V√âG√â -->
      <section id="vegetarien" class="section-card">
        <h2>Plat v√©g√©tarien</h2>
        <div class="badges">
          <span class="badge badge--veg" title="Plat v√©g√©tarien"><span class="emoji">ü•¶</span> V√©g√©</span>
        </div>
        <p id="veg-content">Chili sin carne aux haricots rouges et riz parfum√©.</p>
      </section>



      <!-- ALLERG√àNES -->
      <section id="allergenes" class="section-card">
        <h2>Ingr√©dients & Allerg√®nes</h2>
        <div class="badges">
          <span class="badge badge--warn"><span class="emoji">üåæ</span> Gluten</span>
          <span class="badge badge--warn"><span class="emoji">ü•õ</span> Lactose</span>
          <span class="badge badge--warn"><span class="emoji">ü•ö</span> ≈íuf</span>
          <span class="badge badge--alert"><span class="emoji">ü•ú</span> Fruits √† coque</span>
        </div>
        <ul>
          <li>Contient : gluten, lactose, ≈ìufs</li>
          <li>Sans : arachides</li>
          <li>Option sans gluten disponible sur demande</li>
        </ul>
      </section>


    </main>

    <!-- Sidebar unique combin√©e -->
    <aside class="sidebar-combined">
      <div class="section">
        <h3>Agenda</h3>
        <div class="agenda">
          <label for="filtre-date">Filtrer par date :</label>
          <input type="date" id="filtre-date" />
          <button id="btn-chercher-menu" class="btn-mini btn-chercher-menu">Chercher menu</button>
          <div id="recherche-status" class="recherche-status"></div>
        </div>
        <div id="menu-history">
          <!-- Les menus enregistr√©s appara√Ætront ici -->
        </div>
        <div class="agenda-item">
          <label>
            <input type="checkbox" /> 
            Formation cuisine - Jeudi 15/08
          </label>
        </div>
        <div class="agenda-item">
          <label>
            <input type="checkbox" /> 
            Soir√©e d√©gustation - Vendredi 16/08
          </label>
        </div>
      </div>

      <!-- CHEF d√©plac√© dans la colonne de droite -->
      <div class="section">
        <h3>üë®‚Äçüç≥ Chef du jour</h3>
        <img id="chef-photo-sidebar" src="./Philippe_Etchebest.jpg" alt="Chef" class="chef-photo-sidebar"/>
        <p class="chef-nom"><strong id="chef-nom-sidebar">Philippe Etchebest</strong></p>
        <p id="chef-description-sidebar" class="chef-description">Chef passionn√© par la cuisine du monde et la valorisation des produits locaux.</p>
        <div id="chef-admin-controls" class="chef-admin-controls">
          <a href="./chef-management.html" class="btn-mini chef-edit-btn">‚úèÔ∏è Modifier</a>
        </div>
      </div>

      <!-- HORAIRES d√©plac√©s dans la colonne de droite -->
      <div class="section">
        <h3>üïê Horaires</h3>
        <ul class="horaires-list">
          <li><strong>Petit d√©jeuner :</strong> 07h05 ‚Äì 07h45</li>
          <li><strong>Caf√©t√©ria :</strong> 12h00 ‚Äì 12h45</li>
        </ul>
      </div>

      <div class="section">
        <h3>Informations</h3>
        <p style="color: #666; font-size: 0.9rem; line-height: 1.4;">
          Retrouvez ici les derni√®res actualit√©s de la caf√©t√©ria ORIF-POMY.
        </p>
        <ul style="font-size: 0.85rem; color: #555; line-height: 1.4;">
          <li>Nouvelle carte des desserts</li>
          <li>Produits locaux privil√©gi√©s</li>
          <li>Options v√©g√©tariennes √©tendues</li>
        </ul>
      </div>
    </aside>
  </div>

  <!-- POPUP SIMPLE -->
  <div id="simple-popup" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1000;">
    <div style="position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); background:white; padding:20px; border-radius:8px; width:400px;">
      <h3>Votre avis</h3>
      <p>Notez le menu :</p>
      <div id="simple-stars">
        <span onclick="setRating(1)" style="font-size:30px; cursor:pointer; color:#ddd;">‚òÖ</span>
        <span onclick="setRating(2)" style="font-size:30px; cursor:pointer; color:#ddd;">‚òÖ</span>
        <span onclick="setRating(3)" style="font-size:30px; cursor:pointer; color:#ddd;">‚òÖ</span>
        <span onclick="setRating(4)" style="font-size:30px; cursor:pointer; color:#ddd;">‚òÖ</span>
        <span onclick="setRating(5)" style="font-size:30px; cursor:pointer; color:#ddd;">‚òÖ</span>
      </div>
      <textarea id="simple-comment" placeholder="Commentaire..." rows="3" style="width:100%; margin:10px 0;"></textarea>
      <button id="submit-simple-rating" onclick="submitSimpleRating()" style="background:#007bff; color:white; padding:8px 16px; border:none; border-radius:4px; margin-right:10px;">Envoyer</button>
      <button onclick="closeSimplePopup()" style="background:#6c757d; color:white; padding:8px 16px; border:none; border-radius:4px;">Fermer</button>
    </div>
  </div>

  <footer>
    <p>¬© 2025 ORIF ‚Äì Tous droits r√©serv√©s</p>
    <div class="footer-links">
      <a href="#">Mentions l√©gales</a>
      <a href="#">Conditions d'utilisation</a>
      <a href="#">Politique de confidentialit√©</a>
      <a href="#">Accessibilit√©</a>
    </div>
  </footer>

  <script src="./app.js"></script>
  <script src="./member.js"></script>
  <script>
    let currentRating = 0;
    
    function openSimplePopup() {
      document.getElementById('simple-popup').style.display = 'block';
    }
    
    function closeSimplePopup() {
      document.getElementById('simple-popup').style.display = 'none';
      currentRating = 0;
      updateStars();
      document.getElementById('simple-comment').value = '';
    }
    
    function setRating(rating) {
      currentRating = rating;
      updateStars();
      console.log('Note s√©lectionn√©e:', rating);
    }
    
    function updateStars() {
      const stars = document.querySelectorAll('#simple-stars span');
      stars.forEach((star, index) => {
        star.style.color = index < currentRating ? '#ffcc00' : '#ddd';
      });
    }
    
    function submitSimpleRating() {
      if (currentRating === 0) {
        alert('Veuillez s√©lectionner une note');
        return;
      }
      
      const user = currentUser();
      if (!user) {
        alert('Veuillez vous connecter pour donner votre avis');
        return;
      }
      
      const comment = document.getElementById('simple-comment').value;
      const dateAujourdhui = new Date().toISOString().split('T')[0];
      
      // V√©rifier si l'utilisateur a d√©j√† donn√© un avis aujourd'hui
      const existingAvis = JSON.parse(localStorage.getItem('orif_avis') || '[]');
      const avisExistant = existingAvis.find(a => a.date === dateAujourdhui && a.userId === user.email);
      
      if (avisExistant) {
        const modifier = confirm('Vous avez d√©j√† donn√© un avis aujourd\'hui. Voulez-vous le modifier ?');
        if (!modifier) return;
        
        // Modifier l'avis existant
        avisExistant.rating = currentRating;
        avisExistant.comment = comment;
        avisExistant.timestamp = Date.now();
      } else {
        // Cr√©er un nouvel avis
        const nouvelAvis = {
          date: dateAujourdhui,
          rating: currentRating,
          comment: comment,
          timestamp: Date.now(),
          userId: user.email,
          userName: user.name
        };
        existingAvis.push(nouvelAvis);
      }
      
      localStorage.setItem('orif_avis', JSON.stringify(existingAvis));
      alert('Merci pour votre avis !');
      closeSimplePopup();
      chargerAvisAujourdhui();
    }
    
    // Fonction pour charger et afficher les avis d'aujourd'hui
    function chargerAvisAujourdhui() {
      try {
        const existingAvis = JSON.parse(localStorage.getItem('orif_avis') || '[]');
        const dateAujourdhui = new Date().toISOString().split('T')[0];
        const avisAujourdhui = existingAvis.filter(avis => avis.date === dateAujourdhui);
        
        const avisList = document.getElementById('avis-list');
        const moyenneNote = document.getElementById('moyenne-note');
        
        console.log('DEBUG AVIS - Total:', existingAvis.length, 'Aujourd\'hui:', avisAujourdhui.length);
        
        if (!avisList || !moyenneNote) {
          console.error('√âl√©ments DOM avis-list ou moyenne-note introuvables');
          return;
        }
        
        if (avisAujourdhui.length === 0) {
          avisList.innerHTML = '<li class="aucun-avis">Aucun avis pour aujourd\'hui</li>';
          moyenneNote.textContent = '0';
        } else {
          const moyenne = avisAujourdhui.reduce((sum, avis) => sum + avis.rating, 0) / avisAujourdhui.length;
          moyenneNote.textContent = moyenne.toFixed(1);
          
          const currentUserEmail = currentUser()?.email;
          avisList.innerHTML = avisAujourdhui.map(avis => `
            <li class="avis-item">
              <div class="avis-header">
                <div class="avis-rating">${'‚òÖ'.repeat(avis.rating)}${'‚òÜ'.repeat(5-avis.rating)}</div>
                <small class="avis-author">${avis.userName || 'Anonyme'}</small>
                ${avis.userId === currentUserEmail ? `
                  <div class="avis-actions">
                    <button onclick="modifierAvis('${avis.timestamp}')" class="btn-mini">‚úèÔ∏è</button>
                    <button onclick="supprimerAvis('${avis.timestamp}')" class="btn-mini btn-delete">üóëÔ∏è</button>
                  </div>
                ` : ''}
              </div>
              ${avis.comment ? `<p class="avis-comment">${avis.comment}</p>` : ''}
              <small class="avis-time">${new Date(avis.timestamp).toLocaleTimeString('fr-FR', {hour:'2-digit', minute:'2-digit'})}</small>
            </li>
          `).join('');
          
          console.log('Avis affich√©s avec succ√®s - Moyenne:', moyenne.toFixed(1));
        }
      } catch (error) {
        console.error('Erreur chargement avis - D√âTAIL:', error.message, error.stack);
        // V√©rifier si les √©l√©ments DOM existent
        if (!avisList) console.error('DOM ERROR: avis-list introuvable');
        if (!moyenneNote) console.error('DOM ERROR: moyenne-note introuvable');
      }
    }
    
    function modifierAvis(timestamp) {
      const existingAvis = JSON.parse(localStorage.getItem('orif_avis') || '[]');
      const avis = existingAvis.find(a => a.timestamp == timestamp);
      if (avis) {
        currentRating = avis.rating;
        document.getElementById('simple-comment').value = avis.comment || '';
        updateStars();
        openSimplePopup();
      }
    }
    
    function supprimerAvis(timestamp) {
      if (confirm('√ätes-vous s√ªr de vouloir supprimer votre avis ?')) {
        const existingAvis = JSON.parse(localStorage.getItem('orif_avis') || '[]');
        const nouveauxAvis = existingAvis.filter(a => a.timestamp != timestamp);
        localStorage.setItem('orif_avis', JSON.stringify(nouveauxAvis));
        chargerAvisAujourdhui();
      }
    }
    
    // Charger les avis au d√©marrage
    document.addEventListener('DOMContentLoaded', () => {
      chargerAvisAujourdhui();
    });
  </script>
  <script>
    // Charger les informations du chef depuis localStorage
    function chargerInfoChef() {
      const chefInfo = JSON.parse(localStorage.getItem('orif_chef_info') || '{}');
      const chef = {
        nom: chefInfo.nom || "Monsieur Philippe Etchebest",
        description: chefInfo.description || "Chef passionn√© par la cuisine du monde et la valorisation des produits locaux. Pr√©sent √† l'ORIF depuis 8 ans.",
        photo: chefInfo.photo || "./Philippe_Etchebest.jpg"
      };
      
      const nomElement = document.getElementById('chef-nom');
      const photoElement = document.getElementById('chef-photo');
      const descElement = document.getElementById('chef-description');
      
      if (nomElement) nomElement.textContent = chef.nom;
      if (photoElement) {
        photoElement.src = chef.photo;
        photoElement.alt = 'Chef ' + chef.nom;
      }
      if (descElement) descElement.textContent = chef.description;
    }

    // Charger les infos du chef au d√©marrage
    document.addEventListener('DOMContentLoaded', () => {
      chargerInfoChef();
    });

    // √âcouter les changements du localStorage pour mettre √† jour automatiquement
    window.addEventListener('storage', (e) => {
      if (e.key === 'orif_chef_info') {
        chargerInfoChef();
      }
    });
  </script>

  <script>
    // SOLUTION RADICALE - INITIALISATION COMPL√àTE
    (function() {
      'use strict';
      
      // Charger les informations du chef
      function chargerInfoChef() {
        try {
          const chefInfo = JSON.parse(localStorage.getItem('orif_chef_info') || '{}');
          const chef = {
            nom: chefInfo.nom || "Monsieur Philippe Etchebest",
            description: chefInfo.description || "Chef passionn√© par la cuisine du monde et la valorisation des produits locaux. Pr√©sent √† l'ORIF depuis 8 ans.",
            photo: chefInfo.photo || "./Philippe_Etchebest.jpg"
          };
          
          const nomElement = document.getElementById('chef-nom');
          const photoElement = document.getElementById('chef-photo');
          const descElement = document.getElementById('chef-description');
          
          if (nomElement) nomElement.textContent = chef.nom;
          if (photoElement) {
            photoElement.src = chef.photo;
            photoElement.alt = 'Chef ' + chef.nom;
          }
          if (descElement) descElement.textContent = chef.description;
          
          console.log('Chef charg√©:', chef.nom);
        } catch (error) {
          console.error('Erreur chargement chef:', error);
        }
      }

      // Initialisation principale
      function init() {
        console.log('INITIALISATION COMPL√àTE DE LA PAGE');
        
        // Charger les infos chef
        chargerInfoChef();
        
        // Initialiser les fonctions de membres
        if (typeof initMemberFeatures === 'function') {
          initMemberFeatures();
        }
        
        // Gestion des param√®tres URL
        const urlParams = new URLSearchParams(window.location.search);
        const dateParam = urlParams.get('date');
        
        // Charger le menu du jour
        if (dateParam && typeof chargerMenuDuJour === 'function') {
          console.log('Date sp√©cifique demand√©e:', dateParam);
          chargerMenuDuJour(dateParam);
          const filterInput = document.getElementById('filtre-date');
          if (filterInput) filterInput.value = dateParam;
        } else if (typeof chargerMenuDuJour === 'function') {
          chargerMenuDuJour();
        }
        
        console.log('‚úÖ Initialisation termin√©e');
      }

      // Attendre le DOM et initialiser
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init);
      } else {
        setTimeout(init, 100);
      }

      // √âcouter les changements du localStorage
      window.addEventListener('storage', (e) => {
        if (e.key === 'orif_chef_info') {
          chargerInfoChef();
        }
      });

    })();

  </script>
  
  <footer style="background: #2c3e50; color: white; text-align: center; padding: 2rem 1rem 1rem; margin-top: 2rem;">
    <p style="margin: 0 0 1rem 0; color: white;">¬© 2025 ORIF ‚Äì Tous droits r√©serv√©s</p>
    <div class="footer-links" style="display: flex; justify-content: center; gap: 2rem; flex-wrap: wrap;">
      <a href="#" style="color: #bdc3c7; text-decoration: none; font-size: 0.9rem;">Mentions l√©gales</a>
      <a href="#" style="color: #bdc3c7; text-decoration: none; font-size: 0.9rem;">Conditions d'utilisation</a>
      <a href="#" style="color: #bdc3c7; text-decoration: none; font-size: 0.9rem;">Politique de confidentialit√©</a>
      <a href="#" style="color: #bdc3c7; text-decoration: none; font-size: 0.9rem;">Accessibilit√©</a>
    </div>
  </footer>
</body>
</html>
      });
      
      // Double-clic pour effacer le filtre
      filterDateInput.addEventListener('dblclick', () => {
        filterDateInput.value = '';
        chargerMenuDuJour();
        loadMenuHistoryInAgenda();
        if (statusDiv) statusDiv.innerHTML = '';
      });
    }

    // √âcouter les changements de localStorage pour mettre √† jour l'agenda
    window.addEventListener('storage', (e) => {
      if (e.key === 'orif_menu_history') {
        loadMenuHistoryInAgenda();
      }
    });

    // Recharger l'agenda toutes les 2 secondes pour d√©tecter les changements
    setInterval(() => {
      loadMenuHistoryInAgenda();
    }, 2000);
  </script>
  
  <footer style="background: #2c3e50; color: white; text-align: center; padding: 2rem 1rem 1rem; margin-top: 2rem;">
    <p style="margin: 0 0 1rem 0; color: white;">¬© 2025 ORIF ‚Äì Tous droits r√©serv√©s</p>
    <div class="footer-links" style="display: flex; justify-content: center; gap: 2rem; flex-wrap: wrap;">
      <a href="#" style="color: #bdc3c7; text-decoration: none; font-size: 0.9rem;">Mentions l√©gales</a>
      <a href="#" style="color: #bdc3c7; text-decoration: none; font-size: 0.9rem;">Conditions d'utilisation</a>
      <a href="#" style="color: #bdc3c7; text-decoration: none; font-size: 0.9rem;">Politique de confidentialit√©</a>
      <a href="#" style="color: #bdc3c7; text-decoration: none; font-size: 0.9rem;">Accessibilit√©</a>
    </div>
  </footer>
</body>
</html>