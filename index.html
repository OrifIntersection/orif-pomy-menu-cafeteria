<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Menu ORIF - Menu du jour</title>
  <link rel="stylesheet" href="./assets/style.css"/>
  <link rel="stylesheet" href="./assets/responsive.css"/>
</head>
<body>
  <header>
    <div class="logo-container">
      <img src="./public/images/logo-orif.png" alt="Logo ORIF" class="logo-orif" />
      <div>
        <h1>Cafeteria ORIF-POMY</h1>
      </div>
    </div>

    <div class="user-options">
      <div id="account-area">
        <a class="btn" href="login.html">Se connecter</a>
      </div>
      <select name="langue" id="langue">
        <option value="fr">FR</option>
        <option value="en">EN</option>
        <option value="de">DE</option>
      </select>
    </div>
  </header>

  <nav class="header-nav">
    <div class="nav-container">
      <a href="#plat" class="nav-item active">Plat du jour</a>
      <span class="nav-divider">|</span>
      <a href="#dessert" class="nav-item">Dessert</a>
      <span class="nav-divider">|</span>
      <a href="#self" class="nav-item">Self-service</a>
      <span class="nav-divider">|</span>
      <a href="#salades" class="nav-item">Salades</a>
      <span class="nav-divider">|</span>
      <a href="#vegetarien" class="nav-item">Plat v√©g√©tarien</a>
    </div>
  </nav>

  <div class="main-layout">
    <!-- Contenu principal large -->
    <main class="content">

      <!-- PLAT DU JOUR -->
      <section id="plat" class="section-card">
        <div>
            <h2>Plat du jour</h2>
            <p class="date" id="date-actuelle">Mercredi 14 ao√ªt 2025</p>
        </div>

        <div class="badges" id="plat-badges"></div>
        <img id="plat-img" src="./public/images/plat_jour.jpg" alt="Plat du jour"/>
        <p><strong>Nom :</strong> <span id="plat-nom">Poulet au curry</span></p>
        <p><strong>Description :</strong> <span id="plat-desc">Riz basmati, l√©gumes vapeur</span></p>
        
        <!-- Section avis attach√©e au menu du jour -->
        <div id="avis-section">
          <div class="avis-header-section">
            <h3>Avis sur le menu d'aujourd'hui</h3>
            <button id="open-rating-popup" class="btn btn-rating">Donner mon avis</button>
          </div>
          <div id="moyenne-avis" class="moyenne-avis">Moyenne : <span id="moyenne-note">0</span>/5</div>
          <ul id="avis-list">
            <li class="aucun-avis">Aucun avis pour aujourd'hui</li>
          </ul>
        </div>
      </section>

      <!-- DESSERT -->
      <section id="dessert" class="section-card">
        <h2>Dessert du jour</h2>
        <div class="badges" id="dessert-badges"></div>
        <p id="dessert-content">Cr√®me br√ªl√©e maison avec √©clats de caramel</p>
      </section>

      <!-- SELF -->
      <section id="self" class="section-card">
        <h2>Self-service du jour</h2>
        <ul id="self-list">
          <li>P√¢tes bolognaises</li>
          <li>Pizza 4 fromages</li>
          <li>Gratin de l√©gumes</li>
        </ul>
      </section>

      <!-- SALADES -->
      <section id="salades" class="section-card">
        <h2>Bar √† salades</h2>
        <p>Composez votre salade avec :</p>
        <ul id="salades-list">
          <li>Laitue, roquette, carottes r√¢p√©es</li>
          <li>≈íufs, thon, ma√Øs, tomates cerises</li>
          <li>Vinaigrette maison, sauce yogourt</li>
        </ul>
      </section>

      <!-- V√âG√â -->
      <section id="vegetarien" class="section-card">
        <h2>Plat v√©g√©tarien</h2>
        <div class="badges">
          <span class="badge badge--veg" title="Plat v√©g√©tarien"><span class="emoji">ü•¶</span> V√©g√©</span>
        </div>
        <p id="veg-content">Chili sin carne aux haricots rouges et riz parfum√©.</p>
      </section>



      <!-- ALLERG√àNES -->
      <section id="allergenes" class="section-card">
        <h2>Ingr√©dients & Allerg√®nes</h2>
        <div class="badges">
          <span class="badge badge--warn"><span class="emoji">üåæ</span> Gluten</span>
          <span class="badge badge--warn"><span class="emoji">ü•õ</span> Lactose</span>
          <span class="badge badge--warn"><span class="emoji">ü•ö</span> ≈íuf</span>
          <span class="badge badge--alert"><span class="emoji">ü•ú</span> Fruits √† coque</span>
        </div>
        <ul>
          <li>Contient : gluten, lactose, ≈ìufs</li>
          <li>Sans : arachides</li>
          <li>Option sans gluten disponible sur demande</li>
        </ul>
      </section>


    </main>

    <!-- Sidebar unique combin√©e -->
    <aside class="sidebar-combined">
      <div class="section">
        <h3>Agenda</h3>
        <div class="agenda">
          <label for="filtre-date">Filtrer par date :</label>
          <input type="date" id="filtre-date" />
          <button id="btn-chercher-menu" class="btn-mini btn-chercher-menu">Chercher menu</button>
          <div id="recherche-status" class="recherche-status"></div>
        </div>
        <div id="menu-history">
          <!-- Les menus enregistr√©s appara√Ætront ici -->
        </div>
        <div class="agenda-item">
          <label>
            <input type="checkbox" /> 
            Formation cuisine - Jeudi 15/08
          </label>
        </div>
        <div class="agenda-item">
          <label>
            <input type="checkbox" /> 
            Soir√©e d√©gustation - Vendredi 16/08
          </label>
        </div>
      </div>

      <!-- CHEF d√©plac√© dans la colonne de droite -->
      <div class="section">
        <h3>üë®‚Äçüç≥ Chef du jour</h3>
        <img id="chef-photo-sidebar" src="./public/images/Philippe_Etchebest.jpg" alt="Chef" class="chef-photo-sidebar"/>
        <p class="chef-nom"><strong id="chef-nom-sidebar">Philippe Etchebest</strong></p>
        <p id="chef-description-sidebar" class="chef-description">Chef passionn√© par la cuisine du monde et la valorisation des produits locaux.</p>
        <div id="chef-admin-controls" class="chef-admin-controls">
          <a href="chef-management.html" class="btn-mini chef-edit-btn">‚úèÔ∏è Modifier</a>
        </div>
      </div>

      <!-- HORAIRES d√©plac√©s dans la colonne de droite -->
      <div class="section">
        <h3>üïê Horaires</h3>
        <ul class="horaires-list">
          <li><strong>Petit d√©jeuner :</strong> 07h05 ‚Äì 07h45</li>
          <li><strong>Caf√©t√©ria :</strong> 12h00 ‚Äì 12h45</li>
        </ul>
      </div>

      <div class="section">
        <h3>Informations</h3>
        <p style="color: #666; font-size: 0.9rem; line-height: 1.4;">
          Retrouvez ici les derni√®res actualit√©s de la caf√©t√©ria ORIF-POMY.
        </p>
        <ul style="font-size: 0.85rem; color: #555; line-height: 1.4;">
          <li>Nouvelle carte des desserts</li>
          <li>Produits locaux privil√©gi√©s</li>
          <li>Options v√©g√©tariennes √©tendues</li>
        </ul>
      </div>
    </aside>
  </div>

  <!-- Popup pour donner un avis -->
  <div id="rating-popup" class="popup-overlay" style="display: none;">
    <div class="popup-content">
      <div class="popup-header">
        <h3>Votre avis compte</h3>
        <button id="close-rating-popup" class="popup-close">√ó</button>
      </div>
      <div class="popup-body">
        <div id="rating-form-popup">
          <p>Notez le menu d'aujourd'hui :</p>
          <div class="rating-stars">
            <span class="star" data-rating="1">‚òÖ</span>
            <span class="star" data-rating="2">‚òÖ</span>
            <span class="star" data-rating="3">‚òÖ</span>
            <span class="star" data-rating="4">‚òÖ</span>
            <span class="star" data-rating="5">‚òÖ</span>
          </div>
          <textarea id="comment-popup" placeholder="Votre commentaire (optionnel)..." rows="3"></textarea>
          <div class="popup-actions">
            <button id="submit-rating-popup" class="btn btn-primary">Envoyer mon avis</button>
            <button id="cancel-rating-popup" class="btn btn-secondary">Annuler</button>
          </div>
        </div>
        <div id="rating-login-popup" style="display:none;">
          <p><em>Vous devez √™tre connect√© pour donner votre avis sur le menu.</em></p>
          <div class="popup-actions">
            <a href="login.html" class="btn btn-primary">Se connecter</a>
            <button id="cancel-login-popup" class="btn btn-secondary">Fermer</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <footer>
    <p>¬© 2025 ORIF ‚Äì Tous droits r√©serv√©s</p>
    <div class="footer-links">
      <a href="#">Mentions l√©gales</a>
      <a href="#">Conditions d'utilisation</a>
      <a href="#">Politique de confidentialit√©</a>
      <a href="#">Accessibilit√©</a>
    </div>
  </footer>

  <script src="./assets/app.js"></script>
  <script src="./member.js"></script>
  <script>
    // Charger les informations du chef depuis localStorage
    function chargerInfoChef() {
      const chefInfo = JSON.parse(localStorage.getItem('orif_chef_info') || '{}');
      const chef = {
        nom: chefInfo.nom || "Monsieur Philippe Etchebest",
        description: chefInfo.description || "Chef passionn√© par la cuisine du monde et la valorisation des produits locaux. Pr√©sent √† l'ORIF depuis 8 ans.",
        photo: chefInfo.photo || "./public/images/Philippe_Etchebest.jpg"
      };
      
      const nomElement = document.getElementById('chef-nom');
      const photoElement = document.getElementById('chef-photo');
      const descElement = document.getElementById('chef-description');
      
      if (nomElement) nomElement.textContent = chef.nom;
      if (photoElement) {
        photoElement.src = chef.photo;
        photoElement.alt = 'Chef ' + chef.nom;
      }
      if (descElement) descElement.textContent = chef.description;
    }

    // Charger les infos du chef au d√©marrage
    document.addEventListener('DOMContentLoaded', () => {
      chargerInfoChef();
    });

    // √âcouter les changements du localStorage pour mettre √† jour automatiquement
    window.addEventListener('storage', (e) => {
      if (e.key === 'orif_chef_info') {
        chargerInfoChef();
      }
    });
  </script>
  <script src="admin.js"></script>
  <script>
    // Gestion du popup d'avis
    document.addEventListener('DOMContentLoaded', () => {
      const openPopupBtn = document.getElementById('open-rating-popup');
      const closePopupBtn = document.getElementById('close-rating-popup');
      const cancelPopupBtn = document.getElementById('cancel-rating-popup');
      const cancelLoginBtn = document.getElementById('cancel-login-popup');
      const submitPopupBtn = document.getElementById('submit-rating-popup');
      const popupOverlay = document.getElementById('rating-popup');
      const starsPopup = document.querySelectorAll('#rating-popup .star');
      const commentPopupField = document.getElementById('comment-popup');
      let selectedRatingPopup = 0;

      // Initialiser les fonctions de membres
      initMemberFeatures();
      
      // V√©rifier si une date sp√©cifique est demand√©e via URL
      const urlParams = new URLSearchParams(window.location.search);
      const dateParam = urlParams.get('date');
      
      // Charger le menu du jour depuis le localStorage
      if (dateParam) {
        console.log('Date sp√©cifique demand√©e via URL:', dateParam);
        chargerMenuDuJour(dateParam);
        
        // Mettre √† jour le filtre de date aussi
        const filterInput = document.getElementById('filtre-date');
        if (filterInput) {
          filterInput.value = dateParam;
        }
      } else {
        chargerMenuDuJour();
      }

      // Ouvrir le popup
      if (openPopupBtn) {
        openPopupBtn.addEventListener('click', () => {
          const user = currentUser();
          const ratingFormPopup = document.getElementById('rating-form-popup');
          const ratingLoginPopup = document.getElementById('rating-login-popup');

          if (user && user.role === 'member') {
            ratingFormPopup.style.display = 'block';
            ratingLoginPopup.style.display = 'none';
          } else {
            ratingFormPopup.style.display = 'none';
            ratingLoginPopup.style.display = 'block';
          }

          popupOverlay.style.display = 'flex';
          selectedRatingPopup = 0;
          commentPopupField.value = '';
          updateStarsDisplayPopup();
        });
      }

      // Fermer le popup
      function closePopup() {
        popupOverlay.style.display = 'none';
        selectedRatingPopup = 0;
        commentPopupField.value = '';
        updateStarsDisplayPopup();
      }

      if (closePopupBtn) closePopupBtn.addEventListener('click', closePopup);
      if (cancelPopupBtn) cancelPopupBtn.addEventListener('click', closePopup);
      if (cancelLoginBtn) cancelLoginBtn.addEventListener('click', closePopup);

      // Fermer en cliquant sur l'overlay
      popupOverlay?.addEventListener('click', (e) => {
        if (e.target === popupOverlay) {
          closePopup();
        }
      });

      // √âv√©nements des √©toiles dans le popup
      starsPopup.forEach((star, index) => {
        star.addEventListener('click', () => {
          selectedRatingPopup = index + 1;
          updateStarsDisplayPopup();
        });

        star.addEventListener('mouseenter', () => {
          highlightStarsPopup(index + 1);
        });
      });

      document.querySelector('#rating-popup .rating-stars')?.addEventListener('mouseleave', () => {
        updateStarsDisplayPopup();
      });

      // Soumission de l'avis depuis le popup
      if (submitPopupBtn) {
        submitPopupBtn.addEventListener('click', (e) => {
          e.preventDefault();
          if (selectedRatingPopup === 0) {
            alert('Veuillez s√©lectionner une note avant d\'envoyer votre avis.');
            return;
          }

          const comment = commentPopupField.value.trim();
          if (ajouterAvis(selectedRatingPopup, comment)) {
            alert('Merci pour votre avis !');
            closePopup();
          }
        });
      }

      function highlightStarsPopup(rating) {
        starsPopup.forEach((star, index) => {
          star.classList.toggle('active', index < rating);
        });
      }

      function updateStarsDisplayPopup() {
        highlightStarsPopup(selectedRatingPopup);
      }

      // Afficher la moyenne des avis
      const moyenne = calculerMoyenne();
      const moyenneElement = document.getElementById('moyenne-avis');
      if (moyenneElement && moyenne > 0) {
        moyenneElement.textContent = 'Moyenne du jour: ' + moyenne + '/5 ‚≠ê';
      }

      // Charger l'historique des menus dans l'agenda
      setTimeout(() => {
        loadMenuHistoryInAgenda();
      }, 100);

      // R√©agir aux changements de connexion - pas n√©cessaire avec popup
    });

    // Navigation smooth
    document.querySelectorAll('.nav-item').forEach(link => {
      link.addEventListener('click', (e) => {
        e.preventDefault();
        const targetId = link.getAttribute('href').slice(1);
        const targetSection = document.getElementById(targetId);
        if (targetSection) {
          targetSection.scrollIntoView({ behavior: 'smooth' });
          // Mettre √† jour l'√©tat actif
          document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
          link.classList.add('active');
        }
      });
    });

    // Fonction pour charger l'historique des menus dans l'agenda
    function loadMenuHistoryInAgenda(filterDate = null) {
      // Cette fonction existe uniquement si admin.js est charg√©
      if (typeof getMenuHistory === 'function') {
        const history = getMenuHistory();
        const historyContainer = document.getElementById('menu-history');
        
        if (historyContainer) {
          historyContainer.innerHTML = '';
          
          let filteredHistory = history;
          
          // Filtrer par date si une date est s√©lectionn√©e
          if (filterDate) {
            filteredHistory = history.filter(menu => menu.date === filterDate);
          }
          
          if (filteredHistory.length > 0) {
            // Afficher les menus filtr√©s ou les 5 derniers
            const menusToShow = filterDate ? filteredHistory : filteredHistory.slice(0, 5);
            
            menusToShow.forEach(menu => {
              const dateStr = new Date(menu.date).toLocaleDateString('fr-FR', {
                day: '2-digit',
                month: '2-digit'
              });
              
              const menuItem = document.createElement('div');
              menuItem.className = 'agenda-item menu-history-item';
              menuItem.innerHTML = '<label><input type="checkbox" />üìã ' + menu.platName + ' - ' + dateStr + '</label>';
              historyContainer.appendChild(menuItem);
            });
          } else if (filterDate) {
            // Message si aucun menu trouv√© pour la date
            const noMenuMsg = document.createElement('div');
            noMenuMsg.className = 'agenda-item';
            noMenuMsg.style.fontStyle = 'italic';
            noMenuMsg.style.color = '#6c757d';
            noMenuMsg.textContent = 'Aucun menu pour cette date';
            historyContainer.appendChild(noMenuMsg);
          }
        }
      }
    }

    // Gestion du filtre de date avec bouton de recherche
    const filterDateInput = document.getElementById('filtre-date');
    const btnChercher = document.getElementById('btn-chercher-menu');
    const statusDiv = document.getElementById('recherche-status');
    
    // Bouton de recherche avec feedback visuel
    if (btnChercher) {
      btnChercher.addEventListener('click', () => {
        const dateSelectionnee = filterDateInput ? filterDateInput.value : '';
        if (dateSelectionnee) {
          const dateFormatee = new Date(dateSelectionnee).toLocaleDateString('fr-FR', {
            day: '2-digit',
            month: '2-digit',
            year: 'numeric'
          });
          
          console.log('Recherche du menu pour la date:', dateSelectionnee);
          statusDiv.innerHTML = 'üîç Recherche du menu du ' + dateFormatee + '...';
          statusDiv.style.color = '#007bff';
          
          // Rechercher dans l'historique
          const history = JSON.parse(localStorage.getItem('orif_menu_history') || '[]');
          const menuTrouve = history.find(menu => menu.date === dateSelectionnee);
          
          setTimeout(() => {
            if (menuTrouve) {
              statusDiv.innerHTML = '‚úÖ Menu trouv√© pour le ' + dateFormatee + ' !<br><strong>' + menuTrouve.platName + '</strong>';
              statusDiv.style.color = '#28a745';
              chargerMenuDuJour(dateSelectionnee);
              
              // Scroll vers le haut pour voir le menu
              document.querySelector('main').scrollIntoView({ behavior: 'smooth' });
            } else {
              statusDiv.innerHTML = '‚ùå Aucun menu enregistr√© pour le ' + dateFormatee;
              statusDiv.style.color = '#dc3545';
              
              // Revenir au menu par d√©faut
              chargerMenuDuJour();
            }
          }, 800);
        } else {
          statusDiv.innerHTML = '‚ö†Ô∏è Veuillez s√©lectionner une date';
          statusDiv.style.color = '#ffc107';
        }
      });
    }
    
    // Changement automatique de date
    if (filterDateInput) {
      filterDateInput.addEventListener('change', (e) => {
        const selectedDate = e.target.value;
        if (statusDiv) {
          statusDiv.innerHTML = ''; // Effacer le statut
        }
        
        // Mettre √† jour l'agenda
        loadMenuHistoryInAgenda(selectedDate);
      });
      
      // Double-clic pour effacer le filtre
      filterDateInput.addEventListener('dblclick', () => {
        filterDateInput.value = '';
        chargerMenuDuJour();
        loadMenuHistoryInAgenda();
        if (statusDiv) statusDiv.innerHTML = '';
      });
    }

    // √âcouter les changements de localStorage pour mettre √† jour l'agenda
    window.addEventListener('storage', (e) => {
      if (e.key === 'orif_menu_history') {
        loadMenuHistoryInAgenda();
      }
    });

    // Recharger l'agenda toutes les 2 secondes pour d√©tecter les changements
    setInterval(() => {
      loadMenuHistoryInAgenda();
    }, 2000);
  </script>
  
  <footer style="background: #2c3e50; color: white; text-align: center; padding: 2rem 1rem 1rem; margin-top: 2rem;">
    <p style="margin: 0 0 1rem 0; color: white;">¬© 2025 ORIF ‚Äì Tous droits r√©serv√©s</p>
    <div class="footer-links" style="display: flex; justify-content: center; gap: 2rem; flex-wrap: wrap;">
      <a href="#" style="color: #bdc3c7; text-decoration: none; font-size: 0.9rem;">Mentions l√©gales</a>
      <a href="#" style="color: #bdc3c7; text-decoration: none; font-size: 0.9rem;">Conditions d'utilisation</a>
      <a href="#" style="color: #bdc3c7; text-decoration: none; font-size: 0.9rem;">Politique de confidentialit√©</a>
      <a href="#" style="color: #bdc3c7; text-decoration: none; font-size: 0.9rem;">Accessibilit√©</a>
    </div>
  </footer>
</body>
</html>