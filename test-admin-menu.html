<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Test Admin - Création Menu</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ccc; }
        .success { color: green; }
        .error { color: red; }
        .info { color: blue; }
    </style>
</head>
<body>
    <h1>Test Admin - Création de Menu</h1>
    
    <div class="test-section">
        <h2>1. Connexion Admin</h2>
        <button onclick="testLogin()">Se connecter comme Admin</button>
        <p id="login-result"></p>
    </div>
    
    <div class="test-section">
        <h2>2. Créer Menu Test</h2>
        <button onclick="creerMenuTest()">Créer Menu du Jour</button>
        <p id="menu-result"></p>
    </div>
    
    <div class="test-section">
        <h2>3. Vérifier Menu Créé</h2>
        <button onclick="verifierMenu()">Vérifier Menu</button>
        <p id="verify-result"></p>
    </div>
    
    <div class="test-section">
        <h2>4. Test Bénéficiaire</h2>
        <button onclick="testBeneficiaire()">Se connecter comme Bénéficiaire</button>
        <button onclick="ajouterAvisTest()">Ajouter Avis</button>
        <p id="benef-result"></p>
    </div>

    <script src="assets/app.js"></script>
    <script src="admin.js"></script>
    <script src="member.js"></script>
    <script>
        function testLogin() {
            console.log("=== TEST CONNEXION ADMIN ===");
            const result = login("ayesh.admin@orif.ch", "0000");
            const resultDiv = document.getElementById('login-result');
            
            if (result) {
                resultDiv.innerHTML = '<span class="success">✓ Connexion admin réussie: ' + result.name + ' (' + result.role + ')</span>';
                console.log("Connexion réussie:", result);
            } else {
                resultDiv.innerHTML = '<span class="error">✗ Échec connexion admin</span>';
                console.log("Échec connexion");
            }
        }

        function creerMenuTest() {
            console.log("=== TEST CRÉATION MENU ===");
            const resultDiv = document.getElementById('menu-result');
            
            // Vérifier si admin connecté
            const user = currentUser();
            if (!user || user.role !== 'admin') {
                resultDiv.innerHTML = '<span class="error">✗ Vous devez être connecté comme admin</span>';
                return;
            }

            try {
                // Créer un menu de test
                const today = new Date().toISOString().slice(0, 10);
                const menuTest = {
                    today: {
                        date: today,
                        platName: "Lasagnes Bolognaise Test",
                        platDesc: "Lasagnes maison avec sauce bolognaise, salade verte",
                        platImg: "plat_jour.jpg",
                        platVeg: false,
                        platAllergens: ["gluten", "lactose"],
                        dessertText: "Tiramisu",
                        dessertAllergens: ["lactose", "oeufs"],
                        selfItems: [
                            { name: "Salade César", allergens: ["lactose"] },
                            { name: "Soupe de légumes", allergens: [] }
                        ],
                        saladItems: [
                            { name: "Salade verte", allergens: [] },
                            { name: "Salade de tomates", allergens: [] }
                        ],
                        vegetarien: "Risotto aux champignons",
                        avis: []
                    }
                };

                // Sauvegarder dans localStorage
                localStorage.setItem('orif_menu_data', JSON.stringify(menuTest));
                
                // Ajouter à l'historique
                const historyItem = {
                    id: Date.now(),
                    date: today,
                    platName: "Lasagnes Bolognaise Test",
                    platDesc: "Lasagnes maison avec sauce bolognaise, salade verte",
                    platImg: "plat_jour.jpg",
                    platVeg: false,
                    platAllergens: ["gluten", "lactose"],
                    dessertText: "Tiramisu",
                    dessertAllergens: ["lactose", "oeufs"],
                    selfItems: [
                        { name: "Salade César", allergens: ["lactose"] },
                        { name: "Soupe de légumes", allergens: [] }
                    ],
                    saladItems: [
                        { name: "Salade verte", allergens: [] },
                        { name: "Salade de tomates", allergens: [] }
                    ],
                    vegText: "Risotto aux champignons",
                    timestamp: new Date().toISOString()
                };

                const history = JSON.parse(localStorage.getItem('orif_menu_history') || '[]');
                const filteredHistory = history.filter(item => item.date !== today);
                filteredHistory.unshift(historyItem);
                localStorage.setItem('orif_menu_history', JSON.stringify(filteredHistory));

                resultDiv.innerHTML = '<span class="success">✓ Menu test créé avec succès pour ' + today + '</span>';
                console.log("Menu créé:", menuTest);
                console.log("Historique:", filteredHistory);
                
            } catch (e) {
                resultDiv.innerHTML = '<span class="error">✗ Erreur création menu: ' + e.message + '</span>';
                console.error("Erreur:", e);
            }
        }

        function verifierMenu() {
            console.log("=== VÉRIFICATION MENU ===");
            const resultDiv = document.getElementById('verify-result');
            
            try {
                const menuData = JSON.parse(localStorage.getItem('orif_menu_data') || '{}');
                const history = JSON.parse(localStorage.getItem('orif_menu_history') || '[]');
                
                console.log("Menu data:", menuData);
                console.log("History:", history);
                
                if (menuData.today) {
                    resultDiv.innerHTML = '<span class="success">✓ Menu trouvé: ' + menuData.today.platName + '</span>';
                } else {
                    resultDiv.innerHTML = '<span class="error">✗ Aucun menu trouvé</span>';
                }
                
            } catch (e) {
                resultDiv.innerHTML = '<span class="error">✗ Erreur vérification: ' + e.message + '</span>';
            }
        }

        function testBeneficiaire() {
            console.log("=== TEST CONNEXION BÉNÉFICIAIRE ===");
            const result = login("ayesh.benef@orif.ch", "0000");
            const resultDiv = document.getElementById('benef-result');
            
            if (result) {
                resultDiv.innerHTML = '<span class="success">✓ Connexion bénéficiaire réussie: ' + result.name + ' (' + result.role + ')</span>';
                console.log("Connexion bénéficiaire réussie:", result);
            } else {
                resultDiv.innerHTML = '<span class="error">✗ Échec connexion bénéficiaire</span>';
            }
        }

        function ajouterAvisTest() {
            console.log("=== TEST AVIS BÉNÉFICIAIRE ===");
            const resultDiv = document.getElementById('benef-result');
            
            const user = currentUser();
            if (!user || user.role !== 'member') {
                resultDiv.innerHTML = '<span class="error">✗ Vous devez être connecté comme bénéficiaire</span>';
                return;
            }

            try {
                const success = ajouterAvis(4, "Très bon menu de test !");
                if (success) {
                    resultDiv.innerHTML += '<br><span class="success">✓ Avis ajouté avec succès</span>';
                    console.log("Avis ajouté");
                    
                    // Vérifier les avis
                    const avis = getAvisData();
                    console.log("Avis sauvegardés:", avis);
                } else {
                    resultDiv.innerHTML += '<br><span class="error">✗ Échec ajout avis</span>';
                }
            } catch (e) {
                resultDiv.innerHTML += '<br><span class="error">✗ Erreur avis: ' + e.message + '</span>';
                console.error("Erreur avis:", e);
            }
        }
    </script>
</body>
</html>